<html>

<head>
    <title>Entergy Power After Ida</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script>
        let State = function (images) {
            this.images_ = images;
            this.cur_ = 0;
        }
        State.prototype.back = function () {
            let cur = this.cur_;
            if (this.cur_ > 0) {
                this.cur_--;
            }
            return this.img_ = this.images_[cur];
        };
        State.prototype.img = function () {
            return this.images_[this.cur_];
        }
        State.prototype.images = function () {
            return this.images_;
        }        
        State.prototype.next = function () {
            let cur = this.cur_;
            if (this.cur_ < this.images_.length - 1) {
                this.cur_++;
            }
            return this.images_[cur];
        };
        State.prototype.reset = function () {
            this.cur_ = 0;
        };
        State.prototype.length = function () {
            return this.images_.length;
        };
        State.prototype.current = function () {
            return this.cur_;
        };
        State.prototype.hasNext = function () {
            return this.cur_ < this.images_.length - 1
        };


        let state = null;
        let stopRequested = false;
        let isPlaying = false;
        function createState(allImages) {
            // 1630894846 is blank
            let images = allImages.filter((img) => { return !img.includes('1630894846.png') });
            state = new State(images);
            stopRequested = false;
            isPlaying = false;
        }

        // https://pqina.nl/blog/cropping-images-to-an-aspect-ratio-with-javascript/
      function cropImage(img) {
	const image = new Image();

            image.onload = () => {
                // let's store the width and height of our image
                const inputWidth = image.naturalWidth;
                const inputHeight = image.naturalHeight;

                const outputWidth = $('#play-img').width();
                const top = 330;
                const bottom = 250;
                const outputHeight = $(window).height() - 90;

                // create a canvas that will present the output image
                const outputImage = document.createElement("canvas");

                // set it to the same size as the image
                outputImage.width = outputWidth;
                outputImage.height = outputHeight;

                // draw our image at position 0, 0 on the canvas
                const ctx = outputImage.getContext("2d");
                ctx.drawImage(image, 0, top, inputWidth, inputHeight - top - bottom, 0, 0, outputWidth, outputHeight);

                // show both the image and the canvas
                $('#play-img').empty();
                $('#play-img').append($(outputImage));
            };
            image.src = img;
        }
        
        function render() {
            let img = state.img();
            $('#num').text(state.current());
            cropImage(img);
            let millis = parseInt(img.split('/')[img.split('/').length - 1].replace('.png', '')) * 1000;
          let date = new Date(millis);
	  let d = String(date);
	  d = d.replace(/\s*GMT.*/, '');
          $('#date-link').text(d);
            $('#date-link').attr('href', img);
            let progress = 100 * (state.current() / state.length());
            $('#progressbar').progressbar({ value: progress });
            if (isPlaying) {
                $('#back-btn').prop('disabled', true);
                $('#next-btn').prop('disabled', true);
                $('#play-btn').hide();
                $('#stop-btn').show();
            } else {
                $('#back-btn').prop('disabled', false);
                $('#next-btn').prop('disabled', false);
                $('#play-btn').show();
                $('#stop-btn').hide();
            }
        }

        function play() {
            isPlaying = true;
            render();
            let next = () => {
                if (stopRequested) {
                    stopRequested = false;
                    isPlaying = false;
                    return false;
                }
                if (!state.hasNext()) {
                    isPlaying = false;
                    return false;
                }
                state.next();
                return true;
            };
            let loop = () => {
                let recur = next();
                render();
                let sleep = parseInt($('#speed').val());
                if (recur) setTimeout(loop, sleep);
            };
            loop();
        }

        function reset() {
            state.reset();
            $('#num').text(state.current() + 1);
            $('#den').text(state.length());
            $("#progressbar").progressbar({ value: 0 });
            location.hash = '';
        }

        function back() {
            state.back();
            render();
        }

        function next() {
            state.next();
            render();
        }

        function stop() {
            stopRequested = true;
            $('#play-btn').show();
            $('#stop-btn').hide();
            $('#back-btn').prop('disabled', false);
            $('#next-btn').prop('disabled', false);
        }

        function updateHash() {
            let hash = location.hash || '#';
            let hashValues = hash.substring(1);
            let params = new URLSearchParams(hashValues);
            let speed = $('#speed').val();
            params.set('speed', speed);
            location.hash = params.toString();
        }

        function setFromHash() {
            let hash = location.hash || '#';
            let hashValues = hash.substring(1);
            let params = new URLSearchParams(hashValues);
            let speed = params.get('speed') || 300;
            $('#speed').val(speed);
        }

        function preloadImages(images) {
            $('#loaded-images').text(0);
            $('#total-images').text(images.length);
            let imageStates = {};
            $(images).each((_, src) => {
                imageStates[src] = false;
            });
            let checkReady = () => {
                let numLoaded = 0;
                for (let src in imageStates) {
                    if (imageStates[src]) {
                        numLoaded++;
                    } else {
                        console.log('waiting ' + src);
                    }
                }
                $('#loaded-images').text(numLoaded);
                if (numLoaded == images.length) {
                    $('#play-btn').prop('disabled', false);
                    $('#image-progress').fadeOut();
                }
            };
            $(images).each(function (i, src) {
                let img = $('<img>');
                img.one('load', function () {
                    console.log('loaded ' + src);
                    imageStates[src] = true;
                    checkReady();
                }).each(function () {
                    if (this.complete) {
                        console.log('already loaded ' + src);
                    }
                });
                img.attr('src', this);
            });
        }
        function init() {
            let realInit = () => {
                $('#next-btn').prop('disabled', true);
                $('#back-btn').prop('disabled', true);
                $('#play-btn').prop('disabled', true);
                preloadImages(state.images());
                $('#reset-btn').click(reset);
                $('#back-btn').click(back);
                $('#next-btn').click(next);
                $('#play-btn').click(play);
                $('#stop-btn').click(stop);

                cropImage(state.images()[0]);
                $("#progressbar").progressbar({ value: 0 });
                $('#num').text(0);
                $('#den').text(state.images().length);
                setFromHash();
                $('#speed').change(updateHash);
            };
            $.ajax({
                url: 'animate_images.json',
                context: document.body
            }).done(function (images) {
                createState(images);
                realInit();
            });
        }
        $(document).ready(init);
    </script>
    <style>
        #progressbar {
            width: 400px;
        }

        #play-img {
            padding-top: 10px;
            width: 100%;
        }

        body {
            font-family: sans-serif;
        }

        .home {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>

<body>
    <div>
        <button id="reset-btn">Reset</button>
        <button id="back-btn">Back</button><button id="play-btn">Play</button><button id="stop-btn"
            style="display:none">Stop</button><button id="next-btn">Next</button><select id="speed">
            <option value="200">Fast</option>
            <option value="300">Medium</option>
            <option value="500">Slow</option>
        </select>
        (<span id="num"></span> / <span id="den"></span>)
        <span id="image-progress">Loaded <span id="loaded-images"></span> / <span id="total-images">0</span>
            images</span>
        <span
	  style="
		 background-color: #fff;
		 position:absolute; top:290px; left:590px;
		 font-family: courier;
 "
	  ><a href="" target="_" id="date-link"></a></span>
        <div id="progressbar"></div>
    </div>
    <div id="play-img"></div>
    <div class="home">
        <a href="../">home</a>
    </div>
</body>

</html>
