<html>
    <head>
        <title>Entergy Power After Ida</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">        
        <script>
            IMAGES = [
                "../../etrviewoutagedata/data/screenshots/1630462258.png",
                "../../etrviewoutagedata/data/screenshots/1630462223.png",
                "../../etrviewoutagedata/data/screenshots/1630461949.png",
                "../../etrviewoutagedata/data/screenshots/1630452185.png",
                "../../etrviewoutagedata/data/screenshots/1630448560.png",
                "../../etrviewoutagedata/data/screenshots/1630444936.png",
                "../../etrviewoutagedata/data/screenshots/1630444871.png",
                "../../etrviewoutagedata/data/screenshots/1630437789.png",
                "../../etrviewoutagedata/data/screenshots/1630424699.png",
                "../../etrviewoutagedata/data/screenshots/1630412961.png",
                "../../etrviewoutagedata/data/screenshots/1630412117.png",
                "../../etrviewoutagedata/data/screenshots/1630411953.png",
            ];
            
            IMAGES = [
                "../screenshots/1630465902.png",
                "../screenshots/1630489506.png",
                "../screenshots/1630493668.png",
                "../screenshots/1630496945.png",
                "../screenshots/1630500596.png",
                "../screenshots/1630504245.png",
                "../screenshots/1630507885.png",
                "../screenshots/1630511533.png",
                "../screenshots/1630515181.png",
                "../screenshots/1630518829.png",
                "../screenshots/1630522471.png",
                "../screenshots/1630525045.png",
                "../screenshots/1630528685.png",
                "../screenshots/1630532329.png",
                "../screenshots/1630535976.png",
                "../screenshots/1630539623.png",
                "../screenshots/1630541390.png",
                "../screenshots/1630541582.png",
                "../screenshots/1630545226.png",
                "../screenshots/1630549275.png",
                "../screenshots/1630552914.png",
                "../screenshots/1630556550.png",
                "../screenshots/1630560184.png",
                "../screenshots/1630563820.png",
                "../screenshots/1630567456.png",
                "../screenshots/1630571097.png",
                "../screenshots/1630574732.png",
                "../screenshots/1630578367.png",
                "../screenshots/1630582001.png",
                "../screenshots/1630585557.png",
                "../screenshots/1630587238.png",
                "../screenshots/1630588641.png",
                "../screenshots/1630592283.png",
                "../screenshots/1630595918.png",
                "../screenshots/1630599550.png",
                "../screenshots/1630603182.png",
                "../screenshots/1630604916.png",
                "../screenshots/1630605578.png",
                "../screenshots/1630673755.png",
                "../screenshots/1630675791.png",
                "../screenshots/1630679432.png",
                "../screenshots/1630683067.png",
                "../screenshots/1630686594.png",
                "../screenshots/1630690235.png",
                "../screenshots/1630694171.png",
                "../screenshots/1630697810.png",
                "../screenshots/1630701448.png",
                "../screenshots/1630705087.png",
                "../screenshots/1630708725.png",
                "../screenshots/1630712359.png",
                "../screenshots/1630760051.png",
                "../screenshots/1630761893.png",
                "../screenshots/1630763729.png",
                "../screenshots/1630764834.png",
                "../screenshots/1630766671.png",
                "../screenshots/1630768508.png",
                "../screenshots/1630770344.png",
                "../screenshots/1630772179.png",
                "../screenshots/1630774017.png",
                "../screenshots/1630775856.png",
                "../screenshots/1630777694.png",
                "../screenshots/1630779534.png",
                "../screenshots/1630781372.png",
                "../screenshots/1630783211.png",
                "../screenshots/1630785049.png",
                "../screenshots/1630786889.png",
                "../screenshots/1630788724.png",
                "../screenshots/1630790561.png",
                "../screenshots/1630792397.png",
                "../screenshots/1630794234.png",
                "../screenshots/1630796072.png",
                "../screenshots/1630797907.png",
                "../screenshots/1630799742.png",
                "../screenshots/1630801579.png",
                "../screenshots/1630803416.png",
                "../screenshots/1630805252.png",
                "../screenshots/1630807090.png",
                "../screenshots/1630808926.png",
                "../screenshots/1630810764.png",
                "../screenshots/1630812599.png",
                "../screenshots/1630814435.png",
                "../screenshots/1630816275.png",
                "../screenshots/1630818112.png",
                "../screenshots/1630819949.png",
                "../screenshots/1630821784.png",
                "../screenshots/1630823620.png",
                "../screenshots/1630825457.png",
                "../screenshots/1630827294.png",
                "../screenshots/1630829131.png",
                "../screenshots/1630830968.png",
                "../screenshots/1630832806.png",
                "../screenshots/1630834646.png",
                "../screenshots/1630836483.png",
                "../screenshots/1630838322.png",
                "../screenshots/1630840159.png",
                "../screenshots/1630841998.png",
                "../screenshots/1630843835.png",
                "../screenshots/1630845675.png",
                "../screenshots/1630847514.png",
                "../screenshots/1630849219.png",
                "../screenshots/1630851063.png",
                "../screenshots/1630852819.png",
                "../screenshots/1630854660.png",
                "../screenshots/1630856497.png",
                "../screenshots/1630858335.png",
                "../screenshots/1630860173.png",
                "../screenshots/1630862013.png",
                "../screenshots/1630863851.png",
                "../screenshots/1630865688.png",
                "../screenshots/1630867526.png",
                "../screenshots/1630869364.png",
                "../screenshots/1630871204.png",
                "../screenshots/1630871994.png",
                "../screenshots/1630873834.png",
                "../screenshots/1630875672.png",
                "../screenshots/1630877510.png",
                "../screenshots/1630879349.png",
                "../screenshots/1630881186.png",
                "../screenshots/1630883023.png",
                "../screenshots/1630884860.png",
                "../screenshots/1630886698.png",
                "../screenshots/1630887483.png",
                "../screenshots/1630889328.png",
                "../screenshots/1630891167.png",
                "../screenshots/1630893006.png",
                "../screenshots/1630894846.png",
                
            ];
            
            let State = function(images) {
                this.images_ = images;
                this.cur_ = 0;
            }
            State.prototype.back = function() {
                let cur = this.cur_;
                if (this.cur_ > 0) {
                    this.cur_--;
                }
                return this.img_ = this.images_[cur];
            };
            State.prototype.img = function() {
                return this.images_[this.cur_];
            }
            State.prototype.next = function() {
                let cur = this.cur_;
                if (this.cur_ < this.images_.length - 1) {
                    this.cur_++;
                }
                return this.images_[cur];
            };
            State.prototype.reset = function() {
                this.cur_ = 0;
            };
            State.prototype.length = function() {
                return this.images_.length;
            };
            State.prototype.current = function() {
                return this.cur_;
            };            
            State.prototype.hasNext = function() {
                return this.cur_ < this.images_.length - 1
            };

            let state = new State(IMAGES);
            let stopRequested = false;
            let isPlaying = false;

            function render() {
                let img = state.img();
                $('#num').text(state.current());
                $('#play-img').attr('src', img);
                let millis = parseInt(img.split('/')[img.split('/').length-1].replace('.png', ''))*1000;
                let date = new Date(millis);
                $('#date').text(String(date));
                let progress = 100 * (state.current() / state.length());
                $( "#progressbar" ).progressbar({value: progress});
                if (isPlaying) {
                    $('#back-btn').prop('disabled', true);
                    $('#next-btn').prop('disabled', true);
                    $('#play-btn').hide();
                    $('#stop-btn').show();
                } else {
                    $('#back-btn').prop('disabled', false);
                    $('#next-btn').prop('disabled', false);
                    $('#play-btn').show();
                    $('#stop-btn').hide();
                }
            }
            function play() {
                isPlaying = true;
                render();
                let next = () => {
                    if (stopRequested) {
                        stopRequested = false;
                        isPlaying = false;
                        return false;
                    } 
                    if (!state.hasNext()) {
                        isPlaying = false;
                        return false;
                    }
                    state.next();
                    return true;
                };
                let loop = () => {
                    let recur = next();
                    render();
                    let sleep = parseInt($('#speed').val());
                    if (recur) setTimeout(loop, sleep);
                };
                loop();
            }
            function reset() {
                state.reset();
                $('#num').text(state.current() + 1);
                $('#den').text(state.length());
                $( "#progressbar" ).progressbar({value: 0});                
                location.hash = '';
            }
            function back() {
               state.back();
               render();
            }
            function next() {
               state.next();
               render();
            }
            function stop() {
                stopRequested = true;
                $('#play-btn').show();
                $('#stop-btn').hide();
                $('#back-btn').prop('disabled', false);
                $('#next-btn').prop('disabled', false);
            }
            function updateHash() {
                let hash = location.hash || '#';
                let hashValues = hash.substring(1);
                let params = new URLSearchParams(hashValues);
                let speed = $('#speed').val();
                params.set('speed', speed);
                location.hash = params.toString();
            }
            function setFromHash() {
                let hash = location.hash || '#';
                let hashValues = hash.substring(1);
                let params = new URLSearchParams(hashValues);
                let speed = params.get('speed') || 300;
                $('#speed').val(speed);
            }     
            function preloadImages(images) {
                $('#loaded-images').text(0);
                $('#total-images').text(images.length);
                let imageStates = {};
                $(images).each((_, src) => {
                    imageStates[src] = false;
                });
                let checkReady = () => {
                    let numLoaded = 0;
                    for (let src in imageStates) {
                        if (imageStates[src]) {
                            numLoaded++;
                        } else {
                            console.log('waiting ' + src);
                        }
                    }
                    $('#loaded-images').text(numLoaded);
                    if (numLoaded == images.length) {
                        $('#play-btn').prop('disabled', false);
                        $('#image-progress').fadeOut();
                    }
                };
                $(images).each(function(i, src){
                    let img = $('<img>');
                    img.one('load', function() {
                        console.log('loaded ' + src);
                        imageStates[src] = true;
                    }).each(function() {
                        if(this.complete) {
                            imageStates[src] = true;
                            console.log('already loaded ' + src);
                            checkReady();
                        }
                    });                    
                    img.attr('src', this);
                });
            }                   
            function init() {
                $('#next-btn').prop('disabled', true);                
                $('#back-btn').prop('disabled', true);                
                $('#play-btn').prop('disabled', true);                
                preloadImages(IMAGES);
                $('#reset-btn').click(reset);
                $('#back-btn').click(back);
                $('#next-btn').click(next);
                $('#play-btn').click(play);
                $('#stop-btn').click(stop);
                $('#play-img').attr('src', IMAGES[0]);
                $( "#progressbar" ).progressbar({value: 0});   
                $('#num').text(0);
                $('#den').text(IMAGES.length);
                setFromHash();
                $('#speed').change(updateHash);
            }
            $(document).ready(init);
        </script>   
        <style>
            #play-img {
                width: 100%;
                height: 100%;
            }
            #progressbar {
                width: 400px;
            }
        </style> 
    </head>
    <body>
        <div>
            <button id="reset-btn">Reset</button>
            <button id="back-btn">Back</button><button id="play-btn">Play</button><button id="stop-btn" style="display:none">Stop</button><button id="next-btn">Next</button><select id="speed"><option value="200">Fast</option><option value="300">Medium</option><option value="500">Slow</option></select>
            (<span id="num"></span> / <span id="den"></span>)
            <span id="image-progress">Loaded <span id="loaded-images"></span> / <span id="total-images">0</span> images</span>
            <span id="date"></span>
            <div id="progressbar"></div>
        </div>
        <div id="play-main">
            <img id="play-img"></img>
        </div>
    </body>
</html>