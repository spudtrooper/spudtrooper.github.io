<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }

        #loading {
            margin: 50px;
        }

        .intro {
            margin-bottom: 10px;
        }

        .down {
            color: #44af69;
        }

        .up {
            color: #f8333c;
        }

        .invisible {
            display: none;
        }
    </style>
</head>

<body>
    <div class="intro">
        This shows some ticket prices across seatgeek, stubhub, and vividseats for the Knicks/Kings Game on Jan 23
        sorted by volatility. All the data was gathered with <a
            href="https://github.com/spudtrooper/seats">github.com/spudtrooper/seats</a>. You can search by row or
        search with <code>row:22</code> and/or <code>section:227</code>.
    </div>
    <div>
        <div id="loading">Loading...</div>
        <table id="tab" style="display:none" class="table table-bordered table-sm sortable-table"
            data-sort-name="numPriceChanges" data-sort-order="desc" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="th-sm">Timeline</th>
                    <th class="th-sm">Site</th>
                    <th class="th-sm">Section</th>
                    <th class="th-sm">Row</th>
                    <th class="th-sm">Low</th>
                    <th class="th-sm">High</th>
                    <th class="th-sm">&Delta;</th>
                    <th class="th-sm">Start</th>
                    <th class="th-sm">End</th>
                    <th class="th-sm">Move</th>
                    <th class="th-sm"># Prices</th>
                    <th class="th-sm" data-field="numPriceChanges"># Moves</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        $('#loading').show();
        $('#tab').hide();

        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 700 - margin.left - margin.right,
            height = 100 - margin.top - margin.bottom;


        // Stolen from https://www.d3-graph-gallery.com/graph/line_basic.html
        function addLine(ticket, data, numDistinctValues, numChanges) {
            let tr = $('<tr>');
            $('#tab tbody').append(tr);

            {
                let td = $('<td>');
                $(tr).append(td);
                td.attr('id', ticket);
            }

            var svg = d3.select("#" + ticket)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // Add X axis --> it is a date format
            var x = d3.scaleTime()
                .domain(d3.extent(data, function (d) { return d.date; }))
                .range([0, width]);
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // https://stackoverflow.com/questions/14968615/rounding-to-the-nearest-hundredth-of-a-decimal-in-javascript
            function moneyFormat(num) {
                try {
                    let dollarUS = Intl.NumberFormat("en-US", {
                        style: "currency",
                        currency: "USD",
                    });
                    return dollarUS.format(num);
                } catch (_) { }
                return '$' + Math.ceil(num * 100) / 100;
            }

            // Add Y axis
            let min = d3.min(data, function (d) { return d.value; }),
                max = d3.max(data, function (d) { return d.value; }),
                first = data[0].price,
                last = data[data.length - 1].price,
                change = last - first;
            let diff, diffClass;
            if (last == first) {
                diff = moneyFormat(Math.abs(first - last));
                diffClass = '';
            } else if (last < first) {
                diff = '&darr;' + moneyFormat(Math.abs(first - last));
                diffClass = 'down';
            } else {
                diff = '&uarr;' + moneyFormat(Math.abs(first - last));
                diffClass = 'up';
            }
            var y = d3.scaleLinear()
                .domain([min - (max - min) / 10, max + (max - min) / 10])
                .rangeRound([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(y).ticks(3));

            // Add the line
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function (d) { return x(d.date) })
                    .y(function (d) { return y(d.value) })
                )

            {
                let d = data[0],
                    url = d.url,
                    row = d.row,
                    invisibleRow = '<br/><span class="invisible">row:' + row + '</span>',
                    section = d.section,
                    invisibleSection = '<br/><span class="invisible">section:' + section + '</span>',
                    site = d.site,
                    min = d3.min(data, function (d) { return d.value; }),
                    max = d3.max(data, function (d) { return d.value; });

                $(tr).append($('<td>').append($('<a>').text(site).attr('target', '_').attr('href', url)));
                $(tr).append($('<td>').html(section + invisibleSection));
                $(tr).append($('<td>').html(row + invisibleRow));
                $(tr).append($('<td>').html(moneyFormat(min)));
                $(tr).append($('<td>').html(moneyFormat(max)));
                $(tr).append($('<td>').html(diff).addClass(diffClass));
                $(tr).append($('<td>').html(moneyFormat(first)));
                $(tr).append($('<td>').html(moneyFormat(last)));
                $(tr).append($('<td>').html(moneyFormat(change)).addClass(diffClass));
                $(tr).append($('<td>').text(numDistinctValues));
                $(tr).append($('<td>').text(numChanges));
            }
        }

        function row(d) {
            return {
                activity: d.ticket,
                time: new Date(Date.parse(d.date)),
                date: new Date(Date.parse(d.date)),
                price: +d.price,
                value: +d.price,
                ticket: d.ticket,
                row: d.row,
                section: d.section,
                site: d.site,
                url: d.url,
            };
        }

        // Add a nonce to break the local cache.
        d3.csv('outliers.csv?fake=' + (new Date()), row, function (error, dataAll) {
            if (error) throw error;

            // Find the keys.
            let dataMap = {};

            dataAll.forEach((d) => {
                let key = d.ticket;
                let values = dataMap[key] || [];
                values.push(d);
                dataMap[key] = values;
            });

            let distinctValues = (values) => {
                let set = {};
                values.forEach((v) => {
                    set[v.price] = true;
                });
                return Object.keys(set).length;
            };

            let changes = (values) => {
                let last = 0;
                let changes = 0;
                values.forEach((v, i) => {
                    if (i > 0) {
                        if (v.price != values[i - 1].price) {
                            changes++;
                        }
                    }
                });
                return changes;
            };

            let data = [];
            for (let ticket in dataMap) {
                let values = dataMap[ticket],
                    numDistinctValues = distinctValues(values),
                    numChanges = changes(values);
                let d = {
                    ticket: ticket,
                    values: values,
                    numDistinctValues: numDistinctValues,
                    numChanges: numChanges,
                };
                data.push(d);

            }

            // Sort by number of changes.
            data.sort((a, b) => { return b.numChanges - a.numChanges; });

            data.forEach((d) => {
                addLine(d.ticket, d.values, d.numDistinctValues, d.numChanges);
            });
            $('#loading').hide();
            $('#tab').show();
            $('.sortable-table').DataTable({ "order": [[11, "desc"]] });
            $('.dataTables_length').addClass('bs-select');
            $('select[name="tab_length"]').append($('<option>').attr('value', 9999999999999).text('All'));
        })

    </script>
</body>

</html>