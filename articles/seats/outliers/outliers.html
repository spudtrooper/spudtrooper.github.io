<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }

        #loading {
            margin: 50px;
        }

        .intro {
            margin-bottom: 10px;
            max-width: 1000px;
        }

        .down {
            color: #44af69;
        }

        .up {
            color: #f8333c;
        }

        .invisible {
            display: none;
        }
    </style>
</head>

<body>
    <div class="intro">
        This shows some ticket prices across seatgeek, stubhub, and vividseats for the Knicks/Kings Game on Jan 23
        sorted by volatility. All the data was gathered with <a
            href="https://github.com/spudtrooper/seats">github.com/spudtrooper/seats</a>. You can search by row or
        search with <code>row:22</code> and/or <code>section:227</code>.
    </div>
    <div>
        <div id="loading">Loading...</div>
        <script>
            function customSort(sortName, sortOrder, data) {
                var order = sortOrder === 'desc' ? -1 : 1
                data.sort(function (a, b) {
                    var aa = +((a[sortName] + '').replace(/[^\d]/g, ''))
                    var bb = +((b[sortName] + '').replace(/[^\d]/g, ''))
                    if (aa < bb) {
                        return order * -1
                    }
                    if (aa > bb) {
                        return order
                    }
                    return 0
                })
            }
        </script>
        <table id="tab" style="display:none" class="table table-bordered table-sm sortable-table"
            data-sort-name="numPriceChanges" data-sort-order="desc" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="th-sm">Timeline</th>
                    <th class="th-sm">Site</th>
                    <th class="th-sm" data-sorted="alphanum">Sec</th>
                    <th class="th-sm" data-sorted="alphanum">Row</th>
                    <th class="th-sm" data-sorted="numericonly">Lo</th>
                    <th class="th-sm" data-sorted="numericonly">Hi</th>
                    <th class="th-sm" data-sorted="numericonly">Hi-Lo</th>
                    <th class="th-sm" data-sorted="numericonly">Start</th>
                    <th class="th-sm" data-sorted="numericonly">End</th>
                    <th class="th-sm" data-sorted="numericonly">End-Start</th>
                    <th class="th-sm"># Prices</th>
                    <th class="th-sm" data-field="numPriceChanges"># Moves</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        $('#loading').show();
        $('#tab').hide();

        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 500 - margin.left - margin.right,
            height = 100 - margin.top - margin.bottom;

        // https://www.d3-graph-gallery.com/graph/line_basic.html
        function addRow(ticket, data, numDistinctValues, numChanges) {
            let tr = $('<tr>');
            $('#tab tbody').append(tr);

            {
                let td = $('<td>');
                $(tr).append(td);
                td.attr('id', ticket);
            }

            // https://stackoverflow.com/questions/14968615/rounding-to-the-nearest-hundredth-of-a-decimal-in-javascript
            function moneyFormat(num) {
                try {
                    let dollarUS = Intl.NumberFormat("en-US", {
                        style: "currency",
                        currency: "USD",
                    });
                    return dollarUS.format(num);
                } catch (_) { }
                return '$' + Math.ceil(num * 100) / 100;
            }
            function percentFormat(num) {
                return String(Math.ceil(num * 100) / 100);
            }
            let min = d3.min(data, function (d) { return d.price; }),
                max = d3.max(data, function (d) { return d.price; }),
                start = data[0].price,
                end = data[data.length - 1].price,
                percDiff = percentFormat(100 * (end - start) / start);
            let diffClass;
            if (end < start) {
                diffClass = 'down';
            } else {
                diffClass = 'up';
            }

            var svg = d3.select("#" + ticket)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            const type = 'line';

            if (type == 'line') {
                // Add X axis --> it is a date format
                var x = d3.scaleTime()
                    .domain(d3.extent(data, function (d) { return d.date; }))
                    .range([0, width]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // Add Y axis
                var y = d3.scaleLinear()
                    .domain([min - (max - min) / 10, max + (max - min) / 10])
                    .rangeRound([height, 0]);
                svg.append("g")
                    .call(d3.axisLeft(y).ticks(3));

                // Add the line
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function (d) { return x(d.date) })
                        .y(function (d) { return y(d.price) })
                    )
            }

            if (type == 'bar') {
                // X axis
                let dates = data.map((d) => d.date);
                var x = d3.scaleBand()
                    .range([0, width])
                    .domain(dates);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(10))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end");

                // Add Y axis
                var y = d3.scaleLinear()
                    .domain([min - (max - min) / 10, max + (max - min) / 10])
                    .rangeRound([height, 0]);
                svg.append("g")
                    .call(d3.axisLeft(y).ticks(3));

                // Bars
                svg.selectAll("mybar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("x", function (d) { return x(d.date); })
                    .attr("y", function (d) { return y(d.price); })
                    .attr("width", x.bandwidth())
                    .attr("height", function (d) { return height - y(d.price); })
                    .attr("fill", "#69b3a2");
            }

            {
                let d = data[0],
                    url = d.url,
                    row = d.row,
                    invisibleRow = '<br/><span class="invisible">row:' + row + '</span>',
                    section = d.section,
                    invisibleSection = '<br/><span class="invisible">section:' + section + '</span>',
                    site = d.site;
                $(tr).append($('<td>').append($('<a>').text(site).attr('target', '_').attr('href', url)));
                $(tr).append($('<td>').html(section + invisibleSection));
                $(tr).append($('<td>').html(row + invisibleRow));
                $(tr).append($('<td>').html(moneyFormat(min)).attr('data-value', min));
                $(tr).append($('<td>').html(moneyFormat(max)).attr('data-value', max));
                $(tr).append($('<td>').html(moneyFormat(max - min)).attr('data-value', max - min));
                $(tr).append($('<td>').html(moneyFormat(start)).attr('data-value', start));
                $(tr).append($('<td>').html(moneyFormat(end)).attr('data-value', end));
                $(tr).append($('<td>').html(moneyFormat(end - start)).addClass(diffClass).attr('data-value', end - start));
                $(tr).append($('<td>').text(numDistinctValues).attr('data-value', numDistinctValues));
                $(tr).append($('<td>').text(numChanges).attr('data-value', numChanges));
            }
        }

        function row(d) {
            return {
                activity: d.ticket,
                time: new Date(Date.parse(d.date)),
                date: new Date(Date.parse(d.date)),
                price: +d.price,
                ticket: d.ticket,
                row: d.row,
                section: d.section,
                site: d.site,
                url: d.url,
            };
        }

        // Add a nonce to break the local cache.
        d3.csv('outliers.csv?fake=' + (new Date()), row, function (error, dataAll) {
            if (error) throw error;

            // Find the keys.
            let dataMap = {};

            dataAll.forEach((d) => {
                let key = d.ticket;
                let values = dataMap[key] || [];
                values.push(d);
                dataMap[key] = values;
            });

            let distinctValues = (values) => {
                let set = {};
                values.forEach((v) => {
                    set[v.price] = true;
                });
                return Object.keys(set).length;
            };

            let changes = (values) => {
                let end = 0;
                let changes = 0;
                values.forEach((v, i) => {
                    if (i > 0) {
                        if (v.price != values[i - 1].price) {
                            changes++;
                        }
                    }
                });
                return changes;
            };

            let data = [];
            for (let ticket in dataMap) {
                let values = dataMap[ticket],
                    numDistinctValues = distinctValues(values),
                    numChanges = changes(values);
                let d = {
                    ticket: ticket,
                    values: values,
                    numDistinctValues: numDistinctValues,
                    numChanges: numChanges,
                };
                data.push(d);

            }

            // Sort by number of changes.
            data.sort((a, b) => { return b.numChanges - a.numChanges; });

            data.forEach((d) => {
                addRow(d.ticket, d.values, d.numDistinctValues, d.numChanges);
            });
            $('#loading').hide();
            $('#tab').show();
            $('.sortable-table').DataTable({ "order": [[11, "desc"]] });
            $('.dataTables_length').addClass('bs-select');
            $('select[name="tab_length"]').append($('<option>').attr('value', 9999999999999).text('All'));
        })

    </script>
</body>

</html>